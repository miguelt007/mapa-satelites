<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Mapa Orbital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body, #map { margin: 0; padding: 0; height: 100%; width: 100%; }
    body.dark { background-color: #000; color: #fff; font-family: sans-serif; }

    #sidebar {
      position: absolute;
      top: 0; left: 0;
      width: 280px; height: 100%;
      background: rgba(0, 0, 0, 0.85);
      padding: 15px; z-index: 1000;
      overflow-y: auto; box-shadow: 2px 0 8px rgba(0,255,255,0.2);
    }

    #sidebar h2 { margin-top: 0; color: #0ff; }

    #mapStyleSelect, #sourceSelect, #searchInput {
      width: 100%; padding: 6px;
      margin-bottom: 10px;
      border-radius: 4px; border: none;
    }

    #searchBox { display: flex; }
    #clearBtn {
      margin-left: 5px; cursor: pointer;
      color: #fff; font-weight: bold;
      background: none; border: none;
    }

    #satList {
      list-style: none; padding-left: 0;
    }

    #satList li {
      margin-bottom: 5px;
      padding: 6px;
      border-radius: 5px;
      background: rgba(255,255,255,0.1);
      transition: all 0.4s ease;
    }

    #satList li:hover {
      background-color: rgba(0,255,255,0.2);
    }

    #dataLabel {
      position: absolute; bottom: 10px; left: 10px;
      background: rgba(0,255,255,0.1); color: #0ff;
      padding: 6px 10px; border-radius: 5px;
      font-size: 14px; text-shadow: 1px 1px 3px #000;
      z-index: 500;
    }

    .satellite-label {
      color: #0ff;
      background: rgba(0,0,0,0.6);
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 13px;
      font-weight: bold;
      text-shadow: 0 0 2px #000;
    }

    @media (max-width: 600px) {
      #sidebar { width: 100%; height: 220px; bottom: 0; top: auto; }
      #map { height: calc(100% - 220px); }
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body class="dark">
  <div id="sidebar">
    <h2>üõ∞Ô∏è Sat√©lites Vis√≠veis</h2>
    <select id="mapStyleSelect">
      <option value="osm">üó∫Ô∏è OpenStreetMap</option>
      <option value="dark">üåå Carto Escuro</option>
      <option value="topo">üåø Topogr√°fico</option>
    </select>
    <select id="sourceSelect">
      <option value="active">active</option>
      <option value="starlink">starlink</option>
      <option value="stations">stations</option>
      <option value="weather">weather</option>
      <option value="gps-ops">gps-ops</option>
    </select>
    <div id="searchBox">
      <input type="text" id="searchInput" placeholder="üîç Digite o nome do sat√©lite..." />
      <button id="clearBtn" onclick="clearSearch()">‚úï</button>
    </div>
    <ul id="satList"></ul>
  </div>
  <div id="map"></div>
  <div id="dataLabel">Lista: active</div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/satellite.js@4.0.0/dist/satellite.min.js"></script>
<script>
let map = L.map('map').setView([0, 0], 2);
let tileLayer;

function setMapStyle(style) {
  if (tileLayer) map.removeLayer(tileLayer);

  switch (style) {
    case "dark":
      tileLayer = L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
        attribution: "&copy; CartoDB"
      });
      break;
    case "topo":
      tileLayer = L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenTopoMap"
      });
      break;
    default:
      tileLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors"
      });
  }

  tileLayer.addTo(map);
}

document.getElementById("mapStyleSelect").addEventListener("change", (e) => {
  setMapStyle(e.target.value);
});
setMapStyle("osm");

const customIcons = {
  Comunicacao: L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/1062/1062195.png",
    iconSize: [26, 26]
  }),
  Meteorologico: L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/3566/3566814.png",
    iconSize: [26, 26]
  }),
  Estacao: L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/10290/10290311.png",
    iconSize: [28, 28]
  }),
  Militar: L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/1084/1084254.png",
    iconSize: [26, 26]
  }),
  Generico: L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/1912/1912175.png",
    iconSize: [26, 26]
  })
};

let satMarkers = {};
let orbitLines = {};
const satList = document.getElementById('satList');
const searchInput = document.getElementById('searchInput');
const dataLabel = document.getElementById('dataLabel');
const sourceSelect = document.getElementById('sourceSelect');

function getCategory(name) {
  const n = name.toUpperCase();
  if (n.includes("STARLINK") || n.includes("IRIDIUM")) return "Comunicacao";
  if (n.includes("NOAA") || n.includes("METEOR")) return "Meteorologico";
  if (n.includes("ISS") || n.includes("ZARYA")) return "Estacao";
  if (n.includes("COSMOS") || n.includes("MIL")) return "Militar";
  return "Generico";
}

function propagatePosition(satrec, offsetMinutes = 0) {
  const time = new Date(Date.now() + offsetMinutes * 60000);
  const posVel = satellite.propagate(satrec, time);
  if (!posVel.position) return null;
  const gmst = satellite.gstime(time);
  const gd = satellite.eciToGeodetic(posVel.position, gmst);
  const lat = satellite.degreesLat(gd.latitude);
  const lon = satellite.degreesLong(gd.longitude);
  return (!isNaN(lat) && !isNaN(lon)) ? [lat, lon] : null;
}

function plotOrbit(name, satrec) {
  const path = [];
  for (let i = -30; i <= 30; i += 2) {
    const pos = propagatePosition(satrec, i);
    if (pos) path.push([pos[0], ((pos[1] + 360) % 360) - 180]);
  }
  orbitLines[name] = L.polyline(path, { color: 'cyan', weight: 1 }).addTo(map);
}

function formatDetails(name, line1, line2, lat, lon) {
  const inclination = line2.substring(8, 16).trim();
  const ecc = line2.substring(26, 33).trim();
  const period = line2.substring(52, 63).trim();
  const satId = line1.substring(2, 7).trim();

  return `
    <b>${name}</b><br>
    NORAD ID: ${satId}<br>
    Inclina√ß√£o: ${inclination}¬∞<br>
    Excentricidade: ${ecc}<br>
    Per√≠odo orbital: ${period} min<br>
    Latitude: ${lat.toFixed(2)}<br>
    Longitude: ${lon.toFixed(2)}
  `;
}

function trackSatellite(name, line1, line2) {
  const satrec = satellite.twoline2satrec(line1, line2);
  const category = getCategory(name);
  const icon = customIcons[category];
  const pos = propagatePosition(satrec);
  if (!pos) return;

  const lat = pos[0];
  const lon = pos[1];

  const marker = L.marker(pos, { icon: icon, opacity: 0 }).addTo(map)
    .bindPopup(formatDetails(name, line1, line2, lat, lon));
  marker.getElement().style.transition = "opacity 1.2s ease";
  setTimeout(() => marker.setOpacity(1), 200);

  const tooltip = L.tooltip({
    permanent: true,
    direction: 'right',
    offset: [10, 0],
    className: 'satellite-label'
  }).setContent(name).setLatLng(pos).addTo(map);

  plotOrbit(name, satrec);
  satMarkers[name] = { satrec, marker, category, tooltip };

  const li = document.createElement("li");
  li.className = category;
  li.style.opacity = "0";
  li.style.transform = "translateY(-10px)";
  li.style.transition = "all 0.4s ease";

  const label = document.createElement("label");
  label.style.display = "flex";
  label.style.alignItems = "center";

  const checkbox = document.createElement("input");
  checkbox.type = "checkbox";
  checkbox.checked = true;
  checkbox.style.marginRight = "8px";
  checkbox.onchange = () => {
    const sat = satMarkers[name];
    if (!sat) return;

    if (checkbox.checked) {
      if (!map.hasLayer(sat.marker)) map.addLayer(sat.marker);
      if (orbitLines[name] && !map.hasLayer(orbitLines[name])) map.addLayer(orbitLines[name]);
      if (sat.tooltip && !map.hasLayer(sat.tooltip)) map.addLayer(sat.tooltip);
    } else {
      if (map.hasLayer(sat.marker)) map.removeLayer(sat.marker);
      if (orbitLines[name] && map.hasLayer(orbitLines[name])) map.removeLayer(orbitLines[name]);
      if (sat.tooltip && map.hasLayer(sat.tooltip)) map.removeLayer(sat.tooltip);
    }
  };

  const nameSpan = document.createElement("span");
  nameSpan.textContent = name;
  label.appendChild(checkbox);
  label.appendChild(nameSpan);
  li.appendChild(label);
  satList.appendChild(li);

  setTimeout(() => {
    li.style.opacity = "1";
    li.style.transform = "translateY(0)";
  }, 100);

  li.onclick = () => {
    map.setView(marker.getLatLng(), 4);
    marker.openPopup();
  };

  setInterval(() => {
    const newPos = propagatePosition(satrec);
    if (newPos) {
      marker.setLatLng(newPos);
      marker.setPopupContent(formatDetails(name, line1, line2, newPos[0], newPos[1]));
      if (satMarkers[name].tooltip) satMarkers[name].tooltip.setLatLng(newPos);
    }
  }, 5000);
}

function clearSearch() {
  searchInput.value = "";
  filterList("");
}

function filterList(text) {
  const items = satList.getElementsByTagName("li");
  let anyVisible = false;
  for (let item of items) {
    const match = item.textContent.toLowerCase().includes(text.toLowerCase());
    item.style.display = match ? "" : "none";
    if (match) anyVisible = true;
  }
  dataLabel.textContent = anyVisible ? "Lista: " + sourceSelect.value : "Nenhum sat√©lite encontrado...";
}

searchInput.addEventListener("input", () => filterList(searchInput.value));

function clearSatellites() {
  for (let key in satMarkers) {
    if (map.hasLayer(satMarkers[key].marker)) map.removeLayer(satMarkers[key].marker);
    if (satMarkers[key].tooltip && map.hasLayer(satMarkers[key].tooltip)) map.removeLayer(satMarkers[key].tooltip);
  }
  for (let key in orbitLines) {
    if (map.hasLayer(orbitLines[key])) map.removeLayer(orbitLines[key]);
  }
  satMarkers = {};
  orbitLines = {};
  satList.innerHTML = "";
}

function loadSatellitesFrom(group) {
  if (!group || typeof group !== "string") {
    dataLabel.textContent = "Grupo inv√°lido";
    return;
  }

  const url = `https://celestrak.org/NORAD/elements/gp.php?GROUP=${group}&FORMAT=tle`;
  dataLabel.textContent = "üîÑ A carregar sat√©lites...";

  fetch(url)
    .then(res => res.text())
    .then(text => {
      clearSatellites();
      const lines = text.trim().split('\n');
      let loaded = 0;
      for (let i = 0; i + 2 < lines.length && loaded < 10; i += 3) {
        const name = lines[i].trim();
        const line1 = lines[i + 1].trim();
        const line2 = lines[i + 2].trim();
        trackSatellite(name, line1, line2);
        loaded++;
      }
      dataLabel.textContent = "Lista: " + group;
    })
    .catch(err => {
      console.error("Erro ao carregar TLEs do Celestrak:", err);
      dataLabel.textContent = "Lista: erro ao carregar";
    });
}

sourceSelect.addEventListener("change", () => {
  loadSatellitesFrom(sourceSelect.value);
});

loadSatellitesFrom("active");
</script>
</body>
</html>
