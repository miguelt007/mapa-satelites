<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Mapa Orbital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body, #map { margin: 0; padding: 0; height: 100%; width: 100%; }
    body.dark { background-color: #000; color: #fff; font-family: sans-serif; }
    #sidebar {
      position: absolute;
      top: 0; left: 0; width: 280px; height: 100%;
      background: rgba(0,0,0,0.85); overflow-y: auto; padding: 15px;
      z-index: 1000; box-shadow: 2px 0 8px rgba(0,255,255,0.2);
    }
    #sidebar h2 { margin-top: 0; color: #0ff; }
    #sourceSelect, #searchInput, #mapStyleSelect {
      width: 100%; padding: 6px; margin-bottom: 10px;
      border-radius: 4px; border: none;
    }
    #searchBox { display: flex; }
    #clearBtn {
      margin-left: 5px; cursor: pointer; color: #fff;
      font-weight: bold; background: none; border: none;
    }
    #satList { list-style: none; padding-left: 0; }
    #satList li {
      cursor: pointer; margin-bottom: 5px; padding: 6px;
      border-radius: 5px; background: rgba(255,255,255,0.1);
      transition: all 0.4s ease;
    }
    #satList li:hover { background-color: rgba(0,255,255,0.2); }
    .Comunicacao { color: #0cf; }
    .Meteorologico { color: #0f0; }
    .Militar { color: #f33; }
    .Estacao { color: #b3f; }
    .Generico { color: #aaa; }
    #dataLabel {
      position: absolute; bottom: 10px; left: 10px;
      background: rgba(0,255,255,0.1); color: #0ff;
      padding: 6px 10px; border-radius: 5px;
      font-size: 14px; text-shadow: 1px 1px 3px #000;
      z-index: 500;
    }
    @media (max-width: 600px) {
      #sidebar { width: 100%; height: 220px; bottom: 0; top: auto; }
      #map { height: calc(100% - 220px); }
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body class="dark">
  <div id="sidebar">
    <h2>üõ∞Ô∏è Sat√©lites Vis√≠veis</h2>
    <select id="mapStyleSelect">
      <option value="osm">üó∫Ô∏è OpenStreetMap</option>
      <option value="esri">üõ∞Ô∏è Sat√©lite (ESRI)</option>
      <option value="dark">üåå Carto Escuro</option>
      <option value="topo">üåø Topogr√°fico</option>
    </select>
    <select id="sourceSelect">
      <option value="active">active</option>
      <option value="starlink">starlink</option>
      <option value="stations">stations</option>
      <option value="weather">weather</option>
      <option value="gps-ops">gps-ops</option>
    </select>
    <div id="searchBox">
      <input type="text" id="searchInput" placeholder="üîç Digite o nome do sat√©lite..." />
      <button id="clearBtn" onclick="clearSearch()">‚úï</button>
    </div>
    <ul id="satList"></ul>
  </div>
  <div id="map"></div>
  <div id="dataLabel">Lista: active</div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/satellite.js@4.0.0/dist/satellite.min.js"></script>
  <script>
    let map = L.map('map').setView([0, 0], 2);
    let tileLayer;

    function setMapStyle(style) {
      if (tileLayer) map.removeLayer(tileLayer);
      switch (style) {
        case "esri":
          tileLayer = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{x}/{y}", {
            attribution: "&copy; ESRI"
          });
          break;
        case "dark":
          tileLayer = L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
            attribution: "&copy; CartoDB"
          });
          break;
        case "topo":
          tileLayer = L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; OpenTopoMap"
          });
          break;
        default:
          tileLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; OpenStreetMap contributors"
          });
      }
      tileLayer.addTo(map);
    }

    document.getElementById("mapStyleSelect").addEventListener("change", (e) => {
      setMapStyle(e.target.value);
    });
    setMapStyle("osm");

    let satMarkers = {};
    let orbitLines = {};
    const satList = document.getElementById('satList');
    const searchInput = document.getElementById('searchInput');
    const dataLabel = document.getElementById('dataLabel');
    const sourceSelect = document.getElementById('sourceSelect');

    const customIcons = {
      Comunicacao: L.icon({
        iconUrl: "https://cdn.icon-icons.com/icons2/1380/PNG/512/satellitecommunication_94504.png",
        iconSize: [22, 22]
      }),
      Meteorologico: L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/1086/1086741.png",
        iconSize: [22, 22]
      }),
      Estacao: L.icon({
        iconUrl: "https://upload.wikimedia.org/wikipedia/commons/8/80/ISS_Icon.svg",
        iconSize: [26, 26]
      }),
      Militar: L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/7211/7211969.png",
        iconSize: [22, 22]
      }),
      Generico: L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/9740/9740389.png",
        iconSize: [22, 22]
      })
    };

    function getCategory(name) {
      const n = name.toUpperCase();
      if (n.includes("STARLINK") || n.includes("IRIDIUM")) return "Comunicacao";
      if (n.includes("NOAA") || n.includes("METEOR")) return "Meteorologico";
      if (n.includes("ISS") || n.includes("ZARYA")) return "Estacao";
      if (n.includes("COSMOS") || n.includes("MIL")) return "Militar";
      return "Generico";
    }

    function propagatePosition(satrec, offsetMinutes = 0) {
      const time = new Date(Date.now() + offsetMinutes * 60000);
      const posVel = satellite.propagate(satrec, time);
      if (!posVel.position) return null;
      const gmst = satellite.gstime(time);
      const gd = satellite.eciToGeodetic(posVel.position, gmst);
      const lat = satellite.degreesLat(gd.latitude);
      const lon = satellite.degreesLong(gd.longitude);
      return (!isNaN(lat) && !isNaN(lon)) ? [lat, lon] : null;
    }

    function plotOrbit(name, satrec) {
      const path = [];
    function plotOrbit(name, satrec) {
      const path = [];
      for (let i = -45; i <= 45; i += 5) {
        const pos = propagatePosition(satrec, i);
        if (pos) path.push(pos);
      }
      orbitLines[name] = L.polyline(path, { color: 'cyan', weight: 1 }).addTo(map);
    }

    function trackSatellite(name, line1, line2) {
      const satrec = satellite.twoline2satrec(line1, line2);
      const category = getCategory(name);
      const icon = customIcons[category];

      const pos = propagatePosition(satrec);
      if (!pos) return;

      const marker = L.marker(pos, { icon: icon, opacity: 0 }).addTo(map)
        .bindPopup(`${name}<br>Lat: ${pos[0].toFixed(2)}<br>Lon: ${pos[1].toFixed(2)}`);
      marker.getElement().style.transition = "opacity 1.2s ease";
      setTimeout(() => marker.setOpacity(1), 200);

      plotOrbit(name, satrec);
      satMarkers[name] = { satrec, marker, category };

      const li = document.createElement("li");
      li.textContent = name;
      li.className = category;
      li.style.opacity = "0";
      li.style.transform = "translateY(-10px)";
      li.style.transition = "all 0.4s ease";
      setTimeout(() => {
        li.style.opacity = "1";
        li.style.transform = "translateY(0)";
      }, 100);
      li.onclick = () => {
        marker.setOpacity(1);
        marker.getElement().style.animation = "pulse 0.6s ease";
        setTimeout(() => marker.getElement().style.animation = "", 600);
        map.setView(marker.getLatLng(), 4);
      };
      satList.appendChild(li);

      setInterval(() => {
        const newPos = propagatePosition(satrec);
        if (newPos) {
          marker.setLatLng(newPos);
          marker.setPopupContent(`${name}<br>Lat: ${newPos[0].toFixed(2)}<br>Lon: ${newPos[1].toFixed(2)}`);
        }
      }, 5000);
    }

    function clearSearch() {
      searchInput.value = "";
      filterList("");
    }

    function filterList(text) {
      const items = satList.getElementsByTagName("li");
      for (let item of items) {
        item.style.display = item.textContent.toLowerCase().includes(text.toLowerCase()) ? "" : "none";
      }
    }
    searchInput.addEventListener("input", () => filterList(searchInput.value));

    function clearSatellites() {
      for (let key in satMarkers) {
        map.removeLayer(satMarkers[key].marker);
      }
      for (let key in orbitLines) {
        map.removeLayer(orbitLines[key]);
      }
      satMarkers = {};
      orbitLines = {};
      satList.innerHTML = "";
    }

    function loadSatellitesFrom(group) {
      const url = `https://celestrak.org/NORAD/elements/gp.php?GROUP=${group}&FORMAT=tle`;
      fetch(url)
        .then(res => res.text())
        .then(text => {
          dataLabel.textContent = "Lista: " + group;
          clearSatellites();
          const lines = text.trim().split('\n');
          let loaded = 0;
          for (let i = 0; i + 2 < lines.length && loaded < 5; i += 3) {
            const name = lines[i].trim();
            const line1 = lines[i + 1].trim();
            const line2 = lines[i + 2].trim();
            trackSatellite(name, line1, line2);
            loaded++;
          }
        })
        .catch(err => {
          console.error("Erro ao carregar TLEs do Celestrak:", err);
          dataLabel.textContent = "Lista: erro ao carregar";
        });
    }

        sourceSelect.addEventListener("change", () => {
      loadSatellitesFrom(sourceSelect.value);
    });

    loadSatellitesFrom("active");
  </script>
</body>
</html>

