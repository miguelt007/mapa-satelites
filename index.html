<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Sat√©lites em Tempo Real</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body, #map {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
    }

    body.dark {
      background-color: #000;
      color: #fff;
      font-family: sans-serif;
    }

    #sidebar {
      position: absolute;
      top: 0;
      left: 0;
      width: 280px;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      overflow-y: auto;
      padding: 15px;
      z-index: 1000;
      box-shadow: 2px 0 8px rgba(0, 255, 255, 0.2);
    }

    #sidebar h2 {
      margin-top: 0;
      color: #0ff;
    }

    #searchBox {
      display: flex;
      margin-bottom: 10px;
    }

    #searchInput {
      flex: 1;
      padding: 6px;
      border-radius: 4px;
      border: none;
    }

    #clearBtn {
      margin-left: 5px;
      cursor: pointer;
      color: #fff;
      font-weight: bold;
      background: none;
      border: none;
    }

    #satList {
      list-style: none;
      padding-left: 0;
    }

    #satList li {
      cursor: pointer;
      margin-bottom: 5px;
      padding: 6px;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.1);
    }

    #satList li:hover {
      background-color: rgba(0, 255, 255, 0.2);
    }

    .Comunicacao { color: #0cf; }
    .Meteorologico { color: #0f0; }
    .Militar { color: #f33; }
    .Estacao { color: #b3f; }
    .Generico { color: #aaa; }

    @media (max-width: 600px) {
      #sidebar {
        width: 100%;
        height: 220px;
        bottom: 0;
        top: auto;
      }
      #map {
        height: calc(100% - 220px);
      }
    }
  </style>
</head>
<body class="dark">

<div id="sidebar">
  <h2>üõ∞Ô∏è Sat√©lites Vis√≠veis</h2>
  <div id="searchBox">
    <input type="text" id="searchInput" placeholder="üîç Digite o nome do sat√©lite..." />
    <button id="clearBtn" onclick="clearSearch()">‚úï</button>
  </div>
  <ul id="satList"></ul>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/satellite.js@4.0.0/dist/satellite.min.js"></script>

<script>
const map = L.map('map').setView([0, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

const satMarkers = {};
const orbitLines = {};
const updateInterval = 5000;
const satList = document.getElementById('satList');
const searchInput = document.getElementById('searchInput');

const customIcons = {
  Comunicacao: L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/3214/3214319.png",
    iconSize: [25, 25]
  }),
  Meteorologico: L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/3214/3214320.png",
    iconSize: [25, 25]
  }),
  Militar: L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/3214/3214332.png",
    iconSize: [25, 25]
  }),
  Estacao: L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/3214/3214334.png",
    iconSize: [30, 30]
  }),
  Generico: L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/3214/3214312.png",
    iconSize: [25, 25]
  })
};

function getCategory(name) {
  const n = name.toUpperCase();
  if (n.includes("STARLINK") || n.includes("IRIDIUM")) return "Comunicacao";
  if (n.includes("NOAA") || n.includes("METEOR")) return "Meteorologico";
  if (n.includes("ISS") || n.includes("ZARYA")) return "Estacao";
  if (n.includes("COSMOS") || n.includes("MIL")) return "Militar";
  return "Generico";
}

function propagatePosition(satrec, offsetMinutes = 0) {
  const time = new Date(Date.now() + offsetMinutes * 60000);
  const posVel = satellite.propagate(satrec, time);
  if (!posVel.position) return null;
  const gmst = satellite.gstime(time);
  const gd = satellite.eciToGeodetic(posVel.position, gmst);
  const lat = satellite.degreesLat(gd.latitude);
  const lon = satellite.degreesLong(gd.longitude);
  if (isNaN(lat) || isNaN(lon)) return null;
  return [lat, lon];
}

function plotOrbit(name, satrec) {
  const path = [];
  for (let i = -45; i <= 45; i += 5) {
    const pos = propagatePosition(satrec, i);
    if (pos) path.push(pos);
  }
  const line = L.polyline(path, { color: 'cyan', weight: 1 }).addTo(map);
  orbitLines[name] = line;
}

function trackSatellite(name, line1, line2) {
  const satrec = satellite.twoline2satrec(line1, line2);
  const pos = propagatePosition(satrec);
  if (!pos) return;

  const category = getCategory(name);
  const icon = customIcons[category] || customIcons["Generico"];

  const marker = L.marker(pos, { icon: icon }).addTo(map)
    .bindPopup(`${name}<br>Lat: ${pos[0].toFixed(2)}<br>Lon: ${pos[1].toFixed(2)}`);

  plotOrbit(name, satrec);

  satMarkers[name] = { satrec, marker, category };

  const li = document.createElement("li");
  li.textContent = name;
  li.className = category;
  li.onclick = () => map.setView(marker.getLatLng(), 4);
  satList.appendChild(li);

  setInterval(() => {
    const newPos = propagatePosition(satrec);
    if (newPos) {
      marker.setLatLng(newPos);
      marker.setPopupContent(`${name}<br>Lat: ${newPos[0].toFixed(2)}<br>Lon: ${newPos[1].toFixed(2)}`);
    }
  }, updateInterval);
}

function clearSearch() {
  searchInput.value = "";
  filterList("");
}

function filterList(text) {
  const items = satList.getElementsByTagName("li");
  for (let item of items) {
    item.style.display = item.textContent.toLowerCase().includes(text.toLowerCase()) ? "" : "none";
  }
}

searchInput.addEventListener("input", () => {
  filterList(searchInput.value);
});

// Carrega 5 sat√©lites de active.txt
fetch("https://celestrak.org/NORAD/elements/active.txt")
  .then(res => res.text())
  .then(text => {
    const lines = text.trim().split('\n');
    for (let i = 0; i < 15 && i + 2 < lines.length && i < 5; i += 3) {
      const name = lines[i].trim();
      const line1 = lines[i + 1].trim();
      const line2 = lines[i + 2].trim();
      trackSatellite(name, line1, line2);
      loaded++;
    }
  })
  .catch(err => {
    console.error("Erro ao carregar TLEs do Celestrak:", err);
  });
</script>

</body>
</html>
